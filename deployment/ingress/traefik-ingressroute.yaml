apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: api-posadskiy-com
  namespace: microservices
spec:
  entryPoints:
    - websecure
  routes:
    # Auth Service
    - match: Host(`api.posadskiy.com`) && PathPrefix(`/auth`)
      kind: Rule
      services:
        - name: auth-service
          port: 8100
      middlewares:
        - name: cors-middleware
        - name: strip-prefix-auth
        - name: rate-limit-middleware
      priority: 10
    
    # User Service
    - match: Host(`api.posadskiy.com`) && PathPrefix(`/user`)
      kind: Rule
      services:
        - name: user-service
          port: 8095
      middlewares:
        - name: cors-middleware
        - name: strip-prefix-user
        - name: rate-limit-middleware
      priority: 10
    
    # Email Service
    - match: Host(`api.posadskiy.com`) && PathPrefix(`/email`)
      kind: Rule
      services:
        - name: email-service
          port: 8090
      middlewares:
        - name: cors-middleware
        - name: strip-prefix-email
        - name: rate-limit-middleware
      priority: 10
    
    # Email Template Service
    - match: Host(`api.posadskiy.com`) && PathPrefix(`/email-template`)
      kind: Rule
      services:
        - name: email-template-service
          port: 8091
      middlewares:
        - name: cors-middleware
        - name: strip-prefix-email-template
        - name: rate-limit-middleware
      priority: 10
    
    # Health check endpoint
    - match: Host(`api.posadskiy.com`) && Path(`/health`)
      kind: Rule
      services:
        - name: auth-service
          port: 8100
      priority: 20
  
  tls:
    certResolver: letsencrypt
    domains:
      - main: api.posadskiy.com

---
# Traefik Let's Encrypt configuration
apiVersion: traefik.io/v1alpha1
kind: TLSOption
metadata:
  name: tls-options
  namespace: microservices
spec:
  minVersion: VersionTLS12
  cipherSuites:
    - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
    - TLS_ECDHE_RSA_WITH_AES_128_SHA256
    - TLS_ECDHE_RSA_WITH_AES_256_SHA384

